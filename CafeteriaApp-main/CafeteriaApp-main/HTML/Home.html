<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Home - Delivery</title>
  <link rel="stylesheet" href="/CafeteriaApp-main/CafeteriaApp-main/CSS/Home.css">
</head>
<body>
  <header>
    <h1>Bem vindo, Beltrano!</h1>
    <div class="icons">
      <button id="pedidosBtn">üìñ</button>
      <button id="perfilBtn">üë§</button>
    </div>
  </header>

  <main>
    <input type="text" placeholder="Pesquisar" class="search">

    <button class="titulo">PROMO√á√ÉO DO DIA</button>
    <div class="promocao">
      <div class="imagem"></div>
      <div>
        <p>Hamb√∫rguer do Cicllano</p>
        <p></p>
      </div>
    </div>

    <button class="titulo">Restaurantes dispon√≠veis</button>
    <div class="opcoes" id="listaRestaurantes">
      <!-- Restaurantes ser√£o carregados via API -->
    </div>
  </main>

  <!-- MODAL -->
  <div id="cardapioModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="fecharCardapio()">&times;</span>
      <img id="imagemRestaurante" class="imagem-popup" src="" alt="Imagem do restaurante">
      <h2 id="nomeRestaurante">Card√°pio</h2>
      <ul id="itensCardapio"></ul>
    </div>
  </div>

  <aside id="menuLateral" class="menu-lateral">
    <div class="perfil-header">
      <div class="icon">üë§</div>
      <div class="nome">Beltrano da silva</div>
    </div>
    <ul>
      <li>Perfil</li>
      <li>Configura√ß√µes</li>
      <li>Pagamentos</li>
      <li>Trabalhe conosco</li>
    </ul>
    <button id="fecharMenu">Fechar ‚úñ</button>
  </aside>

<script>
  const perfilBtn = document.getElementById('perfilBtn');
  const pedidosBtn = document.getElementById('pedidosBtn');
  const menuLateral = document.getElementById('menuLateral');
  const fecharMenu = document.getElementById('fecharMenu');

  perfilBtn.onclick = () => menuLateral.style.right = "0";
  fecharMenu.onclick = () => menuLateral.style.right = "-450px";
  pedidosBtn.onclick = () => window.location.href = "pedidos.html";

  const cardapios = {};

  let restauranteAtual = "";

  function abrirCardapio(nome, restauranteId, imagem) {
    restauranteAtual = nome;
    document.getElementById('nomeRestaurante').innerText = `Card√°pio - ${nome}`;
    document.getElementById('imagemRestaurante').src = imagem || "";

    fetch(`https://cafeteriaapp.onrender.com/api/Produto/${restauranteId}/listar`)
      .then(response => response.json())
      .then(produtos => {
        const lista = document.getElementById('itensCardapio');
        lista.innerHTML = "";

        if (produtos.length === 0) {
          lista.innerHTML = "<li>Card√°pio em breve...</li>";
          return;
        }

        produtos.forEach(produto => {
          const li = document.createElement('li');
          li.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <span>${produto.nome} - R$ ${produto.valor.toFixed(2)}</span>
              <button onclick="adicionarItem('${produto.nome}')" class="botao-adicionar" style="padding: 4px 10px; font-size: 0.9rem;">+</button>
            </div>
          `;
          lista.appendChild(li);
        });

        document.getElementById('cardapioModal').style.display = "block";
      })
      .catch(error => {
        console.error("Erro ao buscar card√°pio:", error);
        alert("Erro ao carregar o card√°pio.");
      });
}

  function fecharCardapio() {
    document.getElementById('cardapioModal').style.display = "none";
  }

  function adicionarItem(item) {
    let carrinho = JSON.parse(localStorage.getItem('carrinho')) || [];
    carrinho.push({ restaurante: restauranteAtual, item });
    localStorage.setItem('carrinho', JSON.stringify(carrinho));
    alert(`Item adicionado: ${item}`);
  }

  window.onclick = function(event) {
    const modal = document.getElementById('cardapioModal');
    if (event.target == modal) {
      modal.style.display = "none";
    }
  }

  // üü¢ Busca os restaurantes da API
window.onload = () => {
  const userId = localStorage.getItem('userId');  // pega id do usu√°rio logado

  fetch('https://cafeteriaapp.onrender.com/api/Restaurante/listar')
    .then(response => response.json())
    .then(async (dados) => {
      const container = document.getElementById('listaRestaurantes');
      container.innerHTML = "";

      for (const restaurante of dados) {
        const nome = restaurante.nome || "Restaurante";
        const imagem = restaurante.foto !== "string" ? restaurante.foto : "https://via.placeholder.com/150";
        const avaliacao = restaurante.avaliacao !== null ? `${restaurante.avaliacao.toFixed(1)} ‚≠ê` : "Sem avalia√ß√£o";

        // Chamada para verificar se o usu√°rio √© propriet√°rio deste restaurante
        let isProprietario = false;
        try {
          const proprietariosResp = await fetch(`https://cafeteriaapp.onrender.com/api/UsuarioRestaurante/${restaurante.id}/getProprietarioRestaurante`);
          const proprietarios = await proprietariosResp.json();

          isProprietario = proprietarios.some(p => p.idUsuario.toString() === userId);
        } catch (error) {
          console.error("Erro ao verificar propriet√°rio do restaurante:", error);
        }

        // Criar o card do restaurante
        const card = document.createElement('div');
        card.className = 'card restaurante';
        card.innerHTML = `
          <img src="${imagem}" alt="${nome}">
          <p class="titulo-card">${nome}</p>
          <p>${avaliacao}</p>
          <button class="abrir-cardapio-btn">Abrir Card√°pio</button>
          ${isProprietario ? '<button class="meu-restaurante-btn">Meu Restaurante</button>' : ''}
        `;

        // Evento para abrir card√°pio
        card.querySelector('.abrir-cardapio-btn').onclick = () => abrirCardapio(nome, restaurante.id, imagem);

        // Evento do bot√£o "Meu Restaurante" (se existir)
        if (isProprietario) {
          card.querySelector('.meu-restaurante-btn').onclick = () => {
            alert(`Bem-vindo ao painel do seu restaurante: ${nome}`);
            // Aqui voc√™ pode redirecionar para uma p√°gina exclusiva de controle do restaurante, por exemplo:
             window.location.href = `adminView.html?id=${restaurante.id}`;
          };
        }

        container.appendChild(card);
      }
    })
    .catch(error => {
      console.error("Erro ao buscar restaurantes:", error);
    });
};

</script>

</body>
</html>
